<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kirim Lokasi</title>
  <meta name="description" content="Halaman sederhana untuk meminta izin lokasi dan mengirim koordinat ke server via email.">
  <style>
    body{font-family:Inter,system-ui,Segoe UI, Roboto, sans-serif;display:flex;align-items:center;justify-content:center;height:100vh;margin:0;background:#f7fafc}
    .card{background:white;padding:24px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.08);max-width:640px;width:94%}
    button{padding:10px 16px;border-radius:8px;border:0;font-weight:600;cursor:pointer;background:#2563eb;color:white}
    .info{margin-top:12px;font-size:14px;color:#374151}
    a.small{font-size:13px;color:#6b7280;text-decoration:none}
    footer{margin-top:18px;font-size:13px;color:#6b7280}
  </style>
</head>
<body>
  <div class="card">
    <h1>Kirim Lokasi ke Pemilik Link</h1>
    <p>Dengan menekan tombol di bawah, Anda memberi izin aplikasi ini untuk membaca lokasi akurat dari perangkat Anda dan mengirimkannya ke pemilik link. Lokasi hanya dikirim setelah Anda memberi izin.</p>

    <p><strong>Perhatian privasi:</strong> Pastikan Anda mengetahui tujuan pengiriman lokasi. Aplikasi ini memerlukan HTTPS agar bekerja di sebagian besar browser.</p>

    <button id="sendBtn">Kirim lokasi sekarang</button>
    <div class="info" id="status"></div>

    <footer>
      <p class="small">Parameter opsional: tambahkan <code>?id=IDENTIFIER</code> pada URL untuk menandai penerima/tujuan. Contoh: <code>https://example.com/?id=lokasi-123</code></p>
    </footer>
  </div>

  <script>
    const statusEl = document.getElementById('status')
    const sendBtn = document.getElementById('sendBtn')
    const params = new URLSearchParams(location.search)
    const recipientId = params.get('id') || ''

    function setStatus(msg){ statusEl.textContent = msg }

    async function sendLocation(payload){
      try{
        const resp = await fetch('/api/send-location', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        })
        const j = await resp.json()
        if(resp.ok) setStatus('✅ Lokasi berhasil dikirim. Terima kasih!')
        else setStatus('❌ Gagal mengirim: ' + (j.error || resp.statusText))
      }catch(e){ setStatus('❌ Error jaringan: ' + e.message) }
    }

    sendBtn.addEventListener('click', async ()=>{
      setStatus('Meminta izin lokasi...')
      if(!navigator.geolocation){ setStatus('Perangkat Anda tidak mendukung Geolocation API.'); return }

      navigator.geolocation.getCurrentPosition(async (position)=>{
        const lat = position.coords.latitude
        const lon = position.coords.longitude
        const accuracy = position.coords.accuracy
        const timestamp = new Date(position.timestamp).toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' })
        const mapsLink = `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`

        setStatus('Lokasi diperoleh — mengirim ke server...')
        await sendLocation({
          id: recipientId,
          latitude: lat,
          longitude: lon,
          accuracy: accuracy,
          timestamp: timestamp,
          mapsLink: mapsLink,
          userAgent: navigator.userAgent,
          pageUrl: location.href
        })
      }, (err)=>{
        setStatus('Tidak dapat mendapatkan lokasi: ' + err.message)
      }, {enableHighAccuracy:true, timeout:20000, maximumAge:0})
    })
  </script>
</body>
</html>
